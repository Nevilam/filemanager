from flask import Flask, request, jsonify
from werkzeug.security import generate_password_hash, check_password_hash
import sqlite3
from sqlite3 import Connection
from typing import Optional, List, Dict

DB_PATH = "users.db"

app = Flask(__name__)

def get_db() -> Connection:
    conn = sqlite3.connect(DB_PATH, timeout=10)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    with get_db() as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                password_hash TEXT NOT NULL,
                email TEXT
            )
        """)
    app.logger.info("Database initialized or already exists.")

def find_user(username: str) -> Optional[sqlite3.Row]:
    with get_db() as conn:
        cur = conn.execute("SELECT * FROM users WHERE username = ?", (username,))
        return cur.fetchone()

def create_user(username: str, password: str, email: Optional[str]) -> bool:
    password_hash = generate_password_hash(password)
    try:
        with get_db() as conn:
            conn.execute(
                "INSERT INTO users (username, password_hash, email) VALUES (?, ?, ?)",
                (username, password_hash, email)
            )
        return True
    except sqlite3.IntegrityError:
        return False

@app.route("/", methods=["GET"])
def index():
    return jsonify({"ok": True, "message": "Flask running. Use POST /register and POST /login (JSON)."}), 200

# Маршрут для просмотра пользователей (только для разработки)
@app.route("/users", methods=["GET"])
@app.route("/users/", methods=["GET"])
def list_users():
    with get_db() as conn:
        cur = conn.execute("SELECT id, username, email FROM users")
        rows = cur.fetchall()
        users: List[Dict] = [dict(row) for row in rows]
    return jsonify({"ok": True, "users": users})

@app.route("/register", methods=["POST"])
def register():
    data = request.get_json(silent=True) or {}
    username = (data.get("username") or "").strip()
    password = data.get("password") or ""
    email = (data.get("email") or "").strip()

    if not username or not password or not email:
        return jsonify({"ok": False, "error": "Required fields: username, password, email"}), 400

    if find_user(username):
        return jsonify({"ok": False, "error": "Username already taken"}), 409

    created = create_user(username, password, email)
    if not created:
        return jsonify({"ok": False, "error": "Could not create user"}), 500

    return jsonify({"ok": True, "message": "User registered successfully", "username": username}), 201

@app.route("/login", methods=["POST"])
def login():
    data = request.get_json(silent=True) or {}
    username = (data.get("username") or "").strip()
    password = data.get("password") or ""

    if not username or not password:
        return jsonify({"ok": False, "error": "Required fields: username, password"}), 400

    user = find_user(username)
    if not user or not check_password_hash(user["password_hash"], password):
        return jsonify({"ok": False, "error": "Invalid username or password"}), 401

    return jsonify({"ok": True, "message": "Login successful", "username": username}), 200

if __name__ == "__main__":
    init_db()
    app.run(host="0.0.0.0", port=5000, debug=True)
